<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Usuario</title>
    <link rel="icon" id="favicon" type="image/x-icon" href="">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e6ede8 0%, #e6ede8 50%, #e6ede8 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Logo fijo en la esquina superior izquierda */
        .fixed-logo {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .fixed-logo img {
            width: 200px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            min-height: 500px;
            border: 1px solid #e8eaed;
        }

        /* Login Screen */
        .login-screen {
            padding: 60px 40px;
            text-align: center;
        }

        .login-title {
            color: #2c3e50;
            margin-bottom: 40px;
            font-size: 28px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #ffffff;
            color: #2c3e50;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background: #ffeaea;
            border-radius: 5px;
            display: none;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #7f8c8d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tab svg {
            width: 14px !important;
            height: 14px !important;
            flex-shrink: 0;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: white;
        }

        .tab:hover:not(.active) {
            color: #34495e;
            background: #d5dbdb;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 500;
            color: #34495e;
        }

        .info-value {
            color: #2c3e50;
            font-weight: 400;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #7f8c8d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para QR y estados de WhatsApp */
        .status-connected {
            color: #27ae60;
            background: #d5f4e6;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            border: 2px solid #27ae60;
        }

        .status-connected::before {
            content: 'âœ“';
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
        }

        .qr-progress-container {
            margin-bottom: 20px;
        }

        .qr-progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .qr-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
            border-radius: 4px;
            transition: width 1s linear;
            width: 100%;
        }

        .qr-progress-text {
            display: none;
        }

        .qr-container {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            gap: 30px;
        }

        .qr-code {
            max-width: 200px;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            flex-shrink: 0;
            order: 2;
        }

        .qr-code img {
            width: 100%;
            height: auto;
        }

        .qr-instructions {
            color: #495057;
            line-height: 1.6;
            text-align: left;
            flex: 1;
            order: 1;
        }

        .qr-instructions h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .qr-instructions ol {
            margin: 0;
            padding-left: 20px;
        }

        .qr-instructions li {
            margin-bottom: 8px;
        }

        .regenerate-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-top: 15px;
        }

        .regenerate-btn:hover {
            background: #c0392b;
        }

        .qr-expired {
            color: #e74c3c;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .fixed-logo {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 20px;
            }
            
            .fixed-logo img {
                width: 150px;
            }
            
            .login-screen {
                padding: 40px 20px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .qr-container {
                flex-direction: column;
                text-align: center;
            }
            
            .qr-code {
                order: 1;
                margin: 0 auto;
            }
            
            .qr-instructions {
                order: 2;
                text-align: center;
            }
            
            .qr-instructions ol {
                text-align: left;
                display: inline-block;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Logo fijo en la esquina superior izquierda -->
    <div class="fixed-logo">
        <img id="fixedLogo" src="" alt="Logo">
    </div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <h1 class="login-title">Iniciar SesiÃ³n</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">ContraseÃ±a:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">Iniciar SesiÃ³n</button>
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="Avatar">
                    </div>
                    <span id="userName">Usuario</span>
                </div>
                <button id="logoutBtn" class="logout-btn">Cerrar SesiÃ³n</button>
            </div>

            <div class="tabs" id="tabsContainer">
                <button class="tab active" data-tab="account">InformaciÃ³n de la Cuenta</button>
                <!-- Las pestaÃ±as dinÃ¡micas se insertarÃ¡n aquÃ­ -->
            </div>

            <div id="accountTab" class="tab-content active">
                <div class="loading" id="accountLoading">
                    <div class="spinner"></div>
                    Cargando informaciÃ³n...
                </div>
                <div id="accountContent" style="display: none;">
                    <div class="info-card">
                        <h3>InformaciÃ³n Personal</h3>
                        <div id="personalInfo"></div>
                    </div>
                </div>
            </div>

            <div id="connectionsTab" class="tab-content">
                <div class="loading" id="connectionsLoading">
                    <div class="spinner"></div>
                    Cargando conexiones...
                </div>
                <div id="connectionsContent" style="display: none;">
                    <div class="info-card">
                        <h3>Mis Conexiones</h3>
                        <div id="connectionsList"></div>
                    </div>
                </div>
            </div>

            <!-- PestaÃ±as dinÃ¡micas para redes sociales -->
            <div id="whatsappTab" class="tab-content">
                <div class="loading" id="whatsappLoading">
                    <div class="spinner"></div>
                    Cargando informaciÃ³n de WhatsApp...
                </div>
                <div id="whatsappContent" style="display: none;">
                    <div class="info-card">
                        <h3>WhatsApp</h3>
                        <div id="whatsappStatus"></div>
                    </div>
                </div>
            </div>

            <div id="googleTab" class="tab-content">
                <div class="info-card">
                    <h3>Google</h3>
                    <div class="info-item">
                        <span class="info-label">Estado:</span>
                        <span class="info-value">Conectado</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Servicios:</span>
                        <span class="info-value">Gmail, Google Drive, Google Analytics</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ãšltima sincronizaciÃ³n:</span>
                        <span class="info-value">Hace 10 minutos</span>
                    </div>
                </div>
            </div>

            <div id="facebookTab" class="tab-content">
                <div class="info-card">
                    <h3>Facebook</h3>
                    <div class="info-item">
                        <span class="info-label">Estado:</span>
                        <span class="info-value">Conectado</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">PÃ¡ginas:</span>
                        <span class="info-value">2 pÃ¡ginas vinculadas</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ãšltima sincronizaciÃ³n:</span>
                        <span class="info-value">Hace 15 minutos</span>
                    </div>
                </div>
            </div>

            <div id="instagramTab" class="tab-content">
                <div class="info-card">
                    <h3>Instagram</h3>
                    <div class="info-item">
                        <span class="info-label">Estado:</span>
                        <span class="info-value">Conectado</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tipo de cuenta:</span>
                        <span class="info-value">Cuenta de empresa</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ãšltima sincronizaciÃ³n:</span>
                        <span class="info-value">Hace 8 minutos</span>
                    </div>
                </div>
            </div>

            <div id="tiktokTab" class="tab-content">
                <div class="info-card">
                    <h3>TikTok</h3>
                    <div class="info-item">
                        <span class="info-label">Estado:</span>
                        <span class="info-value">Conectado</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tipo de cuenta:</span>
                        <span class="info-value">TikTok for Business</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ãšltima sincronizaciÃ³n:</span>
                        <span class="info-value">Hace 12 minutos</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n de la API
        const API_URL = window.location.origin + '/api';
        let authToken = localStorage.getItem('authToken');

        // Variables globales
        let currentUser = null;
        let appConfig = null;
        let whatsappCheckInterval = null;
        let progressInterval = null;
        let qrStartTime = null;

        // FunciÃ³n helper para hacer requests a la API
        async function apiRequest(endpoint, options = {}) {
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            if (authToken) {
                config.headers['Authorization'] = `Bearer ${authToken}`;
                console.log('Enviando token:', authToken); // AGREGAR ESTE LOG
            }
            
            console.log('Request completo:', {
                url: `${API_URL}${endpoint}`,
                headers: config.headers
            }); // AGREGAR ESTE LOG

            try {
                const response = await fetch(`${API_URL}${endpoint}`, config);
                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.reload();
                    }
                    throw new Error(data.message || 'Error en la solicitud');
                }

                return data;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }

        // Inicializar la aplicaciÃ³n
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar si hay un usuario guardado
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && authToken) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Verificar que el token sea vÃ¡lido
                    const profile = await apiRequest('/auth/profile');
                    if (profile.success) {
                        currentUser = profile.user;
                        await showDashboard();
                    }
                } catch (error) {
                    console.error('Error verificando sesiÃ³n:', error);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                }
            }
            
            await loadAppConfig();
            setupEventListeners();
        });

        // Cargar configuraciÃ³n de la aplicaciÃ³n
        async function loadAppConfig() {
            try {
                if (currentUser && currentUser.logo_url) {
                    const fixedLogo = document.getElementById('fixedLogo');
                    fixedLogo.src = currentUser.logo_url;
                    fixedLogo.style.display = 'block';
                    
                    if (currentUser.favicon_url) {
                        document.getElementById('favicon').href = currentUser.favicon_url;
                    }
                }
            } catch (error) {
                console.error('Error cargando configuraciÃ³n:', error);
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }

        // Manejar login
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Verificando...';
            errorMessage.style.display = 'none';
            
            try {
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                if (response.success) {
                    authToken = response.token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    
                    currentUser = response.user;
                    await showDashboard();
                }
            } catch (error) {
                showError(error.message || 'Error al iniciar sesiÃ³n');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar SesiÃ³n';
            }
        }

        // Mostrar error
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Manejar logout
        function handleLogout() {
            // Limpiar intervalos
            if (whatsappCheckInterval) {
                clearInterval(whatsappCheckInterval);
                whatsappCheckInterval = null;
            }
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // Limpiar storage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            
            // Redireccionar segÃºn la configuraciÃ³n
            if (appConfig && appConfig.logout_redirect_url) {
                window.location.href = appConfig.logout_redirect_url;
            } else {
                // Volver a la pantalla de login
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                
                // Limpiar formulario
                document.getElementById('loginForm').reset();
                document.getElementById('errorMessage').style.display = 'none';
            }
        }

        // Mostrar dashboard
        async function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Mostrar informaciÃ³n del usuario
            document.getElementById('userName').textContent = currentUser.name || currentUser.username;
            
            if (currentUser.avatar_url) {
                document.getElementById('userAvatar').src = currentUser.avatar_url;
            }
            
            // Actualizar configuraciÃ³n de la app
            appConfig = {
                logo_url: currentUser.logo_url,
                favicon_url: currentUser.favicon_url,
                logout_redirect_url: currentUser.logout_redirect_url
            };
            
            // Actualizar logo y favicon
            if (currentUser.logo_url) {
                const fixedLogo = document.getElementById('fixedLogo');
                fixedLogo.src = currentUser.logo_url;
                fixedLogo.style.display = 'block';
            }
            
            if (currentUser.favicon_url) {
                document.getElementById('favicon').href = currentUser.favicon_url;
            }
            
            // Crear pestaÃ±as dinÃ¡micas
            createDynamicTabs();
            
            // Cargar contenido
            await loadAccountInfo();
        }

        // Crear pestaÃ±as dinÃ¡micas
        function createDynamicTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            const socialNetworks = [
                { 
                    key: 'whatsapp_login', 
                    name: 'WhatsApp', 
                    tabId: 'whatsapp',
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>`
                },
                { 
                    key: 'google_login', 
                    name: 'Google', 
                    tabId: 'google',
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>`
                },
                { 
                    key: 'facebook_login', 
                    name: 'Facebook', 
                    tabId: 'facebook',
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>`
               },
               { 
                   key: 'instagram_login', 
                   name: 'Instagram', 
                   tabId: 'instagram',
                   icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.405a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/></svg>`
               },
               { 
                   key: 'tiktok_login', 
                   name: 'TikTok', 
                   tabId: 'tiktok',
                   icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>`
               }
           ];

           // Limpiar pestaÃ±as existentes (excepto la primera)
           const existingTabs = tabsContainer.querySelectorAll('.tab:not(:first-child)');
           existingTabs.forEach(tab => tab.remove());

           socialNetworks.forEach(network => {
               if (currentUser[network.key] === true) {
                   const tabButton = document.createElement('button');
                   tabButton.className = 'tab';
                   tabButton.dataset.tab = network.tabId;
                   tabButton.innerHTML = `${network.icon}<span>${network.name}</span>`;
                   tabButton.addEventListener('click', function() {
                       switchTab(this.dataset.tab);
                   });
                   tabsContainer.appendChild(tabButton);
               }
           });
       }

       // Cargar informaciÃ³n de la cuenta
       async function loadAccountInfo() {
           try {
               const personalInfo = document.getElementById('personalInfo');
               personalInfo.innerHTML = `
                   <div class="info-item">
                       <span class="info-label">Nombre de Usuario:</span>
                       <span class="info-value">${currentUser.username}</span>
                   </div>
                   <div class="info-item">
                       <span class="info-label">Nombre Completo:</span>
                       <span class="info-value">${currentUser.name || 'No especificado'}</span>
                   </div>
                   <div class="info-item">
                       <span class="info-label">Email:</span>
                       <span class="info-value">${currentUser.email || 'No especificado'}</span>
                   </div>
                   <div class="info-item">
                       <span class="info-label">Fecha de Registro:</span>
                       <span class="info-value">${currentUser.created_at ? new Date(currentUser.created_at).toLocaleString() : 'No especificado'}</span>
                   </div>
                   <div class="info-item">
                       <span class="info-label">Ãšltima ConexiÃ³n:</span>
                       <span class="info-value">${currentUser.last_conexion ? new Date(currentUser.last_conexion).toLocaleString() : 'Primera conexiÃ³n'}</span>
                   </div>
               `;
               
               document.getElementById('accountLoading').style.display = 'none';
               document.getElementById('accountContent').style.display = 'block';
           } catch (error) {
               console.error('Error cargando informaciÃ³n de cuenta:', error);
               document.getElementById('accountLoading').innerHTML = '<p>Error cargando informaciÃ³n</p>';
           }
       }

       // Cambiar pestaÃ±a
       function switchTab(tabName) {
           // NO detener los intervalos al cambiar de pestaÃ±a
           
           // Actualizar botones de pestaÃ±as
           document.querySelectorAll('.tab').forEach(tab => {
               tab.classList.remove('active');
           });
           document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
           
           // Actualizar contenido
           document.querySelectorAll('.tab-content').forEach(content => {
               content.classList.remove('active');
           });
           
           const targetTab = document.getElementById(`${tabName}Tab`);
           if (targetTab) {
               targetTab.classList.add('active');
               
               // Si es la pestaÃ±a de WhatsApp, cargar su contenido
               if (tabName === 'whatsapp' && currentUser.whatsapp_login) {
                   loadWhatsAppStatus();
               }
           }
       }

       // Cargar estado de WhatsApp
        async function loadWhatsAppStatus() {
            const whatsappLoading = document.getElementById('whatsappLoading');
            const whatsappContent = document.getElementById('whatsappContent');
            const whatsappStatus = document.getElementById('whatsappStatus');
           
           // Si hay un QR activo, no recargar
           if (whatsappCheckInterval && progressInterval) {
               if (qrStartTime) {
                   const elapsedSeconds = Math.floor((Date.now() - qrStartTime) / 1000);
                   const remainingSeconds = Math.max(0, 60 - elapsedSeconds);
                   
                   if (remainingSeconds > 0) {
                       const progressFill = document.getElementById('progressFill');
                       if (progressFill) {
                           const percentage = (remainingSeconds / 60) * 100;
                           progressFill.style.width = percentage + '%';
                           if (remainingSeconds <= 10) {
                               progressFill.style.background = 'linear-gradient(90deg, #e74c3c 0%, #c0392b 100%)';
                           }
                       }
                       return;
                   }
               }
           }
           
           whatsappLoading.style.display = 'flex';
           whatsappContent.style.display = 'none';
           
            try {
                const response = await apiRequest('/whatsapp/status');
                
                if (response.success) {
                    if (response.status === 'not_found') {
                        whatsappStatus.innerHTML = '<p>No se encontrÃ³ informaciÃ³n de WhatsApp para este usuario.</p>';
                        whatsappLoading.style.display = 'none';
                        whatsappContent.style.display = 'block';
                        return; // Importante: salir aquÃ­
                    } else if (response.account && response.account.wa_conexion_status === 'connected') {
                        showConnectedStatus(response.account.wa_instance_name);
                    } else if (response.account) {
                        await createWhatsAppInstance(response.account.wa_instance_name);
                    }
                }
                
                whatsappLoading.style.display = 'none';
                whatsappContent.style.display = 'block';
               
            } catch (error) {
                console.error('Error cargando estado de WhatsApp:', error);
                whatsappLoading.style.display = 'none';
                whatsappContent.style.display = 'block';
                whatsappStatus.innerHTML = '<p>Error al cargar la informaciÃ³n de WhatsApp.</p>';
            }
        }

       // Crear instancia de WhatsApp
       async function createWhatsAppInstance(instanceName) {
           try {
               const response = await apiRequest('/whatsapp/create-instance', {
                   method: 'POST',
                   body: JSON.stringify({ instanceName })
               });
               
               if (response.success && response.qrcode) {
                   displayQRCode(response.qrcode.base64 || response.qrcode, instanceName);
                   startConnectionPolling(instanceName);
               } else {
                   throw new Error('No se pudo generar el QR');
               }
               
           } catch (error) {
               console.error('Error creando instancia:', error);
               document.getElementById('whatsappStatus').innerHTML = `
                   <p>Error al crear la instancia de WhatsApp.</p>
                   <button class="regenerate-btn" onclick="regenerateQR('${instanceName}')">Intentar de nuevo</button>
               `;
           }
       }

       // Mostrar QR code
       function displayQRCode(qrcodeBase64, instanceName) {
           const qrSrc = qrcodeBase64.startsWith('data:image') ? qrcodeBase64 : `data:image/png;base64,${qrcodeBase64}`;
           
           document.getElementById('whatsappStatus').innerHTML = `
               <div class="qr-progress-container">
                   <div class="qr-progress-bar" style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                       <div class="qr-progress-fill" id="progressFill" style="height: 100%; background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%); width: 100%; transition: width 1s linear;"></div>
                   </div>
                   <span class="qr-progress-text" id="progressText" style="display: none;">60 segundos restantes</span>
               </div>
               <div class="qr-container" style="display: flex; align-items: flex-start; gap: 30px;">
                   <div class="qr-instructions" style="flex: 1;">
                       <h4>Escanea el cÃ³digo QR con WhatsApp</h4>
                       <ol>
                           <li>Abre WhatsApp en tu telÃ©fono</li>
                           <li>Ve a ConfiguraciÃ³n > Dispositivos vinculados</li>
                           <li>Toca "Vincular un dispositivo"</li>
                           <li>Escanea el cÃ³digo QR</li>
                       </ol>
                       <p class="qr-expired" style="display: none; margin-top: 15px;">El cÃ³digo QR ha expirado</p>
                       <button class="regenerate-btn" onclick="regenerateQR('${instanceName}')" style="display: none;">Generar nuevo QR</button>
                   </div>
                   <div class="qr-code" style="max-width: 200px; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 8px; flex-shrink: 0;">
                       <img src="${qrSrc}" alt="QR Code" style="width: 100%; height: auto;" />
                   </div>
               </div>
           `;
       }

       // Mostrar estado conectado
       function showConnectedStatus(instanceName) {
           document.getElementById('whatsappStatus').innerHTML = `
               <div class="status-connected">
                   Conectado
               </div>
               <div class="info-item" style="margin-top: 20px;">
                   <span class="info-label">Fecha de conexiÃ³n:</span>
                   <span class="info-value">${new Date().toLocaleString()}</span>
               </div>
           `;
       }

       // Regenerar QR
       window.regenerateQR = async function(instanceName) {
           document.getElementById('whatsappLoading').style.display = 'flex';
           document.getElementById('whatsappContent').style.display = 'none';
           await createWhatsAppInstance(instanceName);
           document.getElementById('whatsappLoading').style.display = 'none';
           document.getElementById('whatsappContent').style.display = 'block';
       }

       // Iniciar polling para verificar conexiÃ³n
       function startConnectionPolling(instanceName) {
           if (!whatsappCheckInterval || !progressInterval) {
               if (whatsappCheckInterval) {
                   clearInterval(whatsappCheckInterval);
                   whatsappCheckInterval = null;
               }
               if (progressInterval) {
                   clearInterval(progressInterval);
                   progressInterval = null;
               }
               
               qrStartTime = Date.now();
               
               let attempts = 0;
               const maxAttempts = 12;
               const totalSeconds = 60;
               let remainingSeconds = totalSeconds;
               
               console.log('Iniciando polling para verificar conexiÃ³n de:', instanceName);
               
               // Actualizar barra de progreso
               function updateProgress() {
                   const progressFill = document.getElementById('progressFill');
                   
                   if (progressFill) {
                       const percentage = (remainingSeconds / totalSeconds) * 100;
                       progressFill.style.width = percentage + '%';
                       
                       if (remainingSeconds <= 10) {
                           progressFill.style.background = 'linear-gradient(90deg, #e74c3c 0%, #c0392b 100%)';
                       }
                   }
               }
               
               // Actualizar cada segundo
               progressInterval = setInterval(() => {
                   remainingSeconds--;
                   updateProgress();
                   
                   if (remainingSeconds <= 0) {
                       clearInterval(progressInterval);
                       progressInterval = null;
                   }
               }, 1000);
               
               whatsappCheckInterval = setInterval(async () => {
                   attempts++;
                   console.log(`Intento ${attempts} de ${maxAttempts}`);
                   
                   try {
                       const response = await apiRequest(`/whatsapp/check-connection/${instanceName}`);
                       
                       if (response.success && response.status) {
                           console.log('Estado de conexiÃ³n:', response.status);
                           
                           const isConnected = response.status.state === 'open' || 
                                             response.status.instance?.state === 'open' ||
                                             response.status.status === 'connected' ||
                                             response.status.instance?.status === 'connected';
                           
                           if (isConnected) {
                               console.log('Â¡ConexiÃ³n detectada!');
                               clearInterval(whatsappCheckInterval);
                               clearInterval(progressInterval);
                               whatsappCheckInterval = null;
                               progressInterval = null;
                               qrStartTime = null;
                               
                               // Actualizar estado en el servidor
                               await apiRequest('/whatsapp/update-status', {
                                   method: 'POST',
                                   body: JSON.stringify({
                                       status: 'connected',
                                       instanceName: instanceName
                                   })
                               });
                               
                               showConnectedStatus(instanceName);
                           }
                       }
                       
                       if (attempts >= maxAttempts) {
                           clearInterval(whatsappCheckInterval);
                           clearInterval(progressInterval);
                           whatsappCheckInterval = null;
                           progressInterval = null;
                           qrStartTime = null;
                           
                           const qrExpired = document.querySelector('.qr-expired');
                           const regenerateBtn = document.querySelector('.regenerate-btn');
                           const progressContainer = document.querySelector('.qr-progress-container');
                           
                           if (qrExpired) qrExpired.style.display = 'block';
                           if (regenerateBtn) regenerateBtn.style.display = 'inline-block';
                           if (progressContainer) progressContainer.style.display = 'none';
                           
                           console.log('Polling detenido: QR expirado');
                       }
                       
                   } catch (error) {
                       console.error('Error verificando conexiÃ³n:', error);
                   }
                   
               }, 5000);
           }
       }
   </script>
</body>
</html>
